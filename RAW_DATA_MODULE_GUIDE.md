# 原始数据管理模块使用指南

## 模块概述

原始数据管理模块是集成在水质检测报告系统中的新功能，用于管理水质检测原始数据，支持Excel数据自动化入库、样品编号精准查询、定制化指标模板导出等功能。

## 功能特性

### 1. 数据导入模块

**功能描述：**
- 支持上传包含水质检测数据的Excel文件（.xlsx、.xls格式）
- 首次导入时固化列名配置，后续导入需保持列名一致
- 严格的数据校验机制

**必需字段：**
- 样品编号（唯一标识）
- 所属公司
- 所属水厂
- 水样类型
- 采样时间（必须为YYYY-MM-DD格式，如：2026-01-29）

**校验规则：**
- 列名一致性校验：首次导入后列名固化，后续导入必须完全匹配
- 采样时间格式校验：只接受YYYY-MM-DD格式
- 样品编号唯一性校验：重复时可选择"跳过"、"覆盖"或"终止导入"
- 检测指标值：保留原始小数位数，空值直接入库

**使用步骤：**
1. 进入"数据导入"标签页
2. 选择Excel文件
3. 选择重复处理方式（推荐"跳过"）
4. 点击"开始导入"
5. 查看导入结果报告

### 2. 样品查询模块

**功能描述：**
- 通过样品编号精确检索数据
- 可视化表格展示完整数据
- 支持单条数据导出（Excel/CSV）

**使用步骤：**
1. 进入"样品查询"标签页
2. 输入样品编号
3. 点击"查询"
4. 查看查询结果
5. （可选）点击"导出为Excel"或"导出为CSV"

### 3. 导出模板管理

**功能描述：**
- 创建自定义分类（如：出厂水-常规指标、水源水-重金属）
- 创建导出模板，选定若干检测指标
- 支持模板的修改和删除
- 持久化存储到数据库

**使用步骤：**

**3.1 创建分类**
1. 进入"导出模板"标签页
2. 在"模板分类管理"区域输入分类名称
3. 点击"添加分类"

**3.2 创建模板**
1. 选择分类（可选）
2. 输入模板名称
3. 在检测指标列表中勾选需要的指标
4. 点击"创建模板"

**注意：** 样品编号和采样时间会自动包含在导出模板中

### 4. 筛选导出模块

**功能描述：**
- 支持单维度筛选（所属公司、所属水厂、水样类型、采样时间范围）
- 文本类维度支持模糊匹配（包含匹配）
- 支持全选或手动勾选样品
- 支持采样时间升序/降序排列
- 生成Excel文件，文件名按导出时间命名（YYYYMMDDHHMMSS.xlsx）

**使用步骤：**
1. 进入"筛选导出"标签页
2. 选择导出模板
3. 设置筛选条件（可选）：
   - 选择筛选维度
   - 输入筛选值或选择日期范围
4. 点击"预览筛选结果"查看符合条件的样品
5. 选择要导出的样品（全选或手动勾选）
6. 选择排序方式（升序/降序）
7. 点击"导出Excel"

## 数据表设计

系统使用以下数据表存储原始数据：

### raw_data_column_schema
列名配置表，存储系统固化的列名
- column_name: 列名
- column_order: 列顺序
- data_type: 数据类型（text/numeric/date）
- is_base_field: 是否为基础字段

### raw_data_records
原始数据记录表
- sample_number: 样品编号（唯一）
- company_name: 所属公司
- plant_name: 所属水厂
- sample_type: 水样类型
- sampling_date: 采样时间

### raw_data_values
原始数据检测值表（EAV模式）
- record_id: 关联记录ID
- column_name: 列名
- value: 检测值

### export_template_categories
导出模板分类表
- name: 分类名称

### export_templates
导出模板表
- category_id: 分类ID
- name: 模板名称
- description: 描述

### export_template_columns
导出模板列关联表
- template_id: 模板ID
- column_name: 列名
- column_order: 列顺序

## API接口

### 数据导入
- POST `/api/raw-data/upload` - 上传并导入Excel数据

### 数据查询
- GET `/api/raw-data/columns` - 获取列名配置
- POST `/api/raw-data/search` - 样品编号查询
- POST `/api/raw-data/export-single` - 导出单条记录

### 模板管理
- GET/POST/DELETE `/api/export-templates/categories` - 分类管理
- GET/POST `/api/export-templates` - 模板列表和创建
- PUT/DELETE `/api/export-templates/<id>` - 修改/删除模板

### 筛选导出
- POST `/api/raw-data/filter-preview` - 预览筛选结果
- POST `/api/raw-data/filter-export` - 筛选并导出

## 访问入口

1. 登录系统后，在主页面点击"数据管理"标签
2. 点击"原始数据管理"卡片的"进入管理"按钮
3. 或直接访问：`http://your-server:5000/raw-data-manager`

## 注意事项

1. **首次导入很重要**：首次导入的Excel列名将被固化，后续所有导入必须保持列名一致
2. **日期格式严格**：采样时间必须为YYYY-MM-DD格式，其他格式将被拒绝
3. **样品编号唯一**：系统会自动检测重复的样品编号，请根据实际需求选择处理方式
4. **数据完整性**：删除记录时会级联删除相关的检测值数据
5. **权限控制**：所有功能需要登录后才能使用

## 典型使用流程

### 流程1：首次使用
1. 准备Excel文件，确保包含所有必需字段
2. 导入数据（首次导入会固化列名）
3. 创建模板分类和导出模板
4. 使用筛选导出功能

### 流程2：日常使用
1. 导入新的检测数据
2. 使用样品查询功能查看特定样品
3. 使用筛选导出功能批量导出数据

### 流程3：数据更正
1. 准备更正后的Excel数据
2. 导入时选择"覆盖"模式
3. 验证数据是否正确更新

## 技术特性

- **数据库优化**：使用索引优化查询性能
- **数据完整性**：使用外键约束保证数据一致性
- **并发支持**：WAL模式支持多用户并发访问
- **容错处理**：详细的错误提示和警告信息
- **灵活性**：EAV模式支持动态列结构

## 故障排查

### 问题1：导入失败，提示列名不匹配
**解决方法：** 检查Excel文件的列名是否与系统固化的列名完全一致（包括顺序）

### 问题2：采样时间格式错误
**解决方法：** 确保采样时间列的格式为YYYY-MM-DD，可在Excel中设置单元格格式为文本

### 问题3：样品编号重复
**解决方法：**
- 如果是新数据，选择"跳过"
- 如果是更新数据，选择"覆盖"
- 如果需要检查，选择"终止导入"

### 问题4：无法看到检测指标选项
**解决方法：** 需要先导入数据以初始化列名配置

## 更新日志

**v1.0.0 (2026-01-29)**
- 初始版本发布
- 实现数据导入功能
- 实现样品查询功能
- 实现模板管理功能
- 实现筛选导出功能
