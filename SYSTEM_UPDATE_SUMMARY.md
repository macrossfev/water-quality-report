# 水质报告生成系统更新说明

## 更新日期
2026-01-27

## 已完成的功能

### 1. 数据库模型更新 ✅
**文件**: `models_v2.py`

#### 更新内容:
- **sample_types表**: 添加 `remark` 字段，用于存储样品类型备注信息
- **indicator_groups表**: 添加 `is_system` 字段，标记系统分组（系统分组不可删除）
- **indicators表**: 添加以下字段
  - `limit_value`: 检测指标的限值标准
  - `detection_method`: 检测方法
  - `remark`: 备注信息

#### 数据库迁移:
- 创建了迁移脚本 `migrate_database.py`
- 已成功迁移现有数据库，所有新字段已添加
- 现有的三个默认分组（理化指标、微生物指标、重金属指标）已标记为系统分组

### 2. 后端API更新 ✅
**文件**: `app_v2.py`

#### 样品类型API (`/api/sample-types`)
- ✅ 支持 `remark` 字段的创建、读取、更新
- ✅ 新增搜索功能: 支持按样品名称或备注搜索 (`?search=关键词`)
- ✅ 保留原有的导入导出Excel功能

#### 检测指标API (`/api/indicators`)
- ✅ 支持 `limit_value`, `detection_method`, `remark` 字段的完整CRUD操作
- ✅ 保留原有的分组筛选功能
- ✅ 保留原有的导入导出Excel功能

#### 指标分组API (`/api/indicator-groups`)
- ✅ 支持自定义新增分组（is_system=0）
- ✅ 系统分组保护机制：标记为系统分组的不可删除
- ✅ 返回分组时包含 `is_system` 字段信息

### 3. 专项管理页面 ✅

#### 样品类型管理页面 (`/sample-types-manager`)
**文件**: `templates/sample_types_manager.html`

**功能特性**:
- ✅ 精美的响应式设计
- ✅ 实时搜索（按名称或备注）
- ✅ 分页显示（每页10条记录）
- ✅ 完整的CRUD操作（添加、编辑、删除）
- ✅ 支持备注字段编辑
- ✅ 导入导出Excel功能
- ✅ 返回主页按钮

**字段展示**:
- 序号、名称、代码、说明、**备注**、操作

#### 检测指标管理页面 (`/indicators-manager`)
**文件**: `templates/indicators_manager.html`

**功能特性**:
- ✅ 精美的响应式设计
- ✅ **分组筛选**: 点击分组标签即可筛选
- ✅ 实时搜索（按指标名称或备注）
- ✅ 分页显示（每页10条记录）
- ✅ 完整的CRUD操作
- ✅ **分组管理**: 可添加、编辑、删除自定义分组（系统分组保护）
- ✅ 支持新增字段: **限值**、**检测方法**、**备注**
- ✅ 导入导出Excel功能
- ✅ 返回主页按钮

**字段展示**:
- 序号、指标名称、单位、分组、**限值**、**检测方法**、默认值、**备注**、操作

### 4. 主页面更新 ✅
**文件**: `templates/index_v2.html`

**更新内容**:
- ✅ 将样品类型管理和检测指标管理改为入口卡片
- ✅ 点击"进入管理"按钮跳转到专项页面
- ✅ 保留模版配置功能区
- ✅ 优化界面布局和视觉效果

---

## 待完成的功能

### 1. 模版配置界面更新 ⏳
**需求**: 在配置检测项目时显示分组和备注信息

**实现方案**:
- 修改模版配置区域的检测项目列表显示
- 添加分组和备注列
- 保持原有的配置功能

**预计文件**:
- `templates/index_v2.html` (修改模版配置区域)
- `static/js/app.js` (如果有相关JavaScript代码)

### 2. 报告模版数据模型 ⏳
**需求**: 支持多页报告模版配置

**参考**: `/sample/报告模版.xlsx`

**需要识别的模版内容**:

#### 封面页（出1/原1）:
- 报告编号: `( 06 )字( 2025 )第( 220 )号`
- 页码: `第 1 页 共 5 页`
- 单位名称: `国家城市供水水质监测网重庆监测站`
- 样品名称: `出厂水【朱家岩水厂】`
- 委托单位: `重庆经济技术开发区建设服务中心`
- 委托单位地址: `重庆市南岸区江桥路1号`
- 报告编制日期: `2025 年 3 月 31 日`

#### 样品信息页（出2/原2）:
- 样品类型、样品来源、采样人、采样日期
- 采样依据、收样日期、采样地点
- 样品状态、样品编号、检测日期
- 产品标准、检测项目（列表）
- 检测结论、附加信息
- 编制/审核/签发人员和日期

#### 检测数据页（出3-4/原3-4）:
- 序号、项目、单位、检测结果、标准限值、检测方法
- 支持多页数据展示

#### 报告说明页（出5/原5）:
- 固定的说明文字
- 监测站联系信息

**实现方案**:
1. 创建报告模版数据模型（新增数据表）
2. 支持导入Excel模版并识别结构
3. 存储模版配置（页面布局、单元格位置等）
4. 支持自定义调整模版

### 3. 报告模版管理功能 ⏳
**需求**: 支持导入导出Excel模版，自定义调整

**功能规划**:
- 导入Excel模版文件
- 自动识别模版结构和变量位置
- 支持模版预览
- 支持导出模版配置
- 支持多个模版管理（出厂水、原水等不同类型）

### 4. 报告填写模块更新 ⏳
**需求**: 识别报告模版中需要变更的内容

**实现方案**:
- 根据报告模版自动生成填写表单
- 包含所有需要变更的字段
- 支持选择不同的报告模版
- 自动填充默认值

**需要填写的内容**:
- 基本信息: 报告编号、样品编号、样品类型、委托单位等
- 样品信息: 采样人、采样日期、采样地点、样品状态等
- 检测数据: 各项检测指标的检测结果
- 人员信息: 检测人员、审核人员、签发人员

### 5. 按模版生成Excel报告 ⏳
**需求**: 根据报告模版和填写的数据生成完整的Excel报告

**实现方案**:
1. 读取报告模版Excel文件
2. 根据模版配置定位需要填充的单元格
3. 填充用户输入的数据
4. 保持模版的格式和样式
5. 生成最终的报告文件

**技术选型**:
- 使用 `openpyxl` 库操作Excel文件
- 支持复制模版工作表
- 支持多页报告生成

---

## 系统使用指南

### 启动系统

1. **运行数据库迁移**（首次更新时）:
```bash
cd /home/macrossfev/water-quality-report
python3 migrate_database.py
```

2. **启动应用**:
```bash
python3 app_v2.py
```

3. **访问系统**:
- 主页: http://localhost:5000
- 样品类型管理: http://localhost:5000/sample-types-manager
- 检测指标管理: http://localhost:5000/indicators-manager

### 功能使用说明

#### 样品类型管理
1. 在主页点击"样品类型管理"卡片的"进入管理"按钮
2. 可进行搜索、添加、编辑、删除操作
3. 支持添加备注信息
4. 支持导入导出Excel

#### 检测指标管理
1. 在主页点击"检测指标管理"卡片的"进入管理"按钮
2. 可通过分组标签筛选指标
3. 支持搜索、添加、编辑、删除操作
4. 可设置限值和检测方法
5. 可管理分组（添加/编辑自定义分组）
6. 系统分组（理化指标、微生物指标、重金属指标）不可删除

---

## 文件清单

### 新增文件
- `migrate_database.py` - 数据库迁移脚本
- `templates/sample_types_manager.html` - 样品类型管理专项页面
- `templates/indicators_manager.html` - 检测指标管理专项页面
- `SYSTEM_UPDATE_SUMMARY.md` - 本文档

### 修改文件
- `models_v2.py` - 数据库模型更新
- `app_v2.py` - API和路由更新
- `templates/index_v2.html` - 主页面入口更新

---

## 技术说明

### 数据库结构变更

```sql
-- sample_types表新增字段
ALTER TABLE sample_types ADD COLUMN remark TEXT;

-- indicator_groups表新增字段
ALTER TABLE indicator_groups ADD COLUMN is_system BOOLEAN DEFAULT 0;

-- indicators表新增字段
ALTER TABLE indicators ADD COLUMN limit_value TEXT;
ALTER TABLE indicators ADD COLUMN detection_method TEXT;
ALTER TABLE indicators ADD COLUMN remark TEXT;
```

### API端点更新

```
GET /api/sample-types?search=关键词        # 搜索样品类型
GET /api/indicators?group_id=1             # 按分组筛选指标
GET /sample-types-manager                   # 样品类型管理页面
GET /indicators-manager                     # 检测指标管理页面
```

### 分页实现
- 前端实现分页逻辑
- 每页显示10条记录
- 支持页码跳转
- 显示总记录数

---

## 下一步建议

1. **优先级1 - 模版配置界面更新**
   - 工作量: 小
   - 预计时间: 1-2小时
   - 建议立即实施

2. **优先级2 - 报告模版功能开发**
   - 工作量: 大
   - 预计时间: 8-12小时
   - 需要详细设计方案
   - 建议分阶段实施:
     - 阶段1: 报告模版数据模型设计
     - 阶段2: 模版导入和识别
     - 阶段3: 报告填写界面
     - 阶段4: 按模版生成报告

3. **优先级3 - 系统测试**
   - 测试所有新增功能
   - 测试数据完整性
   - 测试用户体验

---

## 注意事项

1. **数据备份**: 在进行任何数据库操作前，建议先备份数据库
2. **浏览器兼容性**: 推荐使用Chrome、Firefox或Edge浏览器
3. **数据迁移**: 首次更新时必须运行 `migrate_database.py`
4. **系统分组**: 理化指标、微生物指标、重金属指标为系统分组，不可删除
5. **搜索功能**: 搜索使用模糊匹配，支持中文

---

## 联系方式

如有问题或建议，请联系系统管理员。
