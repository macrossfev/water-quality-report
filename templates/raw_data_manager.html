<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>原始数据管理 - 水质检测系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar navbar-dark bg-primary">
        <div class="container-fluid">
            <a href="/" class="navbar-brand mb-0 h1">
                <i class="bi bi-arrow-left-circle"></i> 返回主页
            </a>
            <span class="navbar-brand mb-0 h1">
                <i class="bi bi-database-fill"></i> 原始数据管理
            </span>
            <div class="d-flex align-items-center text-white">
                <span class="me-3">
                    <i class="bi bi-person-circle"></i>
                    <span id="currentUsername">用户</span>
                </span>
            </div>
        </div>
    </nav>

    <!-- 主内容 -->
    <div class="container-fluid mt-3">
        <!-- 标签页导航 -->
        <ul class="nav nav-tabs" id="dataTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="import-tab" data-bs-toggle="tab" data-bs-target="#import" type="button">
                    <i class="bi bi-upload"></i> 数据导入
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="search-tab" data-bs-toggle="tab" data-bs-target="#search" type="button">
                    <i class="bi bi-search"></i> 样品查询
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="template-tab" data-bs-toggle="tab" data-bs-target="#template" type="button">
                    <i class="bi bi-file-earmark-text"></i> 导出模板
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="export-tab" data-bs-toggle="tab" data-bs-target="#export" type="button">
                    <i class="bi bi-download"></i> 筛选导出
                </button>
            </li>
        </ul>

        <!-- 标签页内容 -->
        <div class="tab-content mt-3" id="dataTabContent">
            <!-- 数据导入 -->
            <div class="tab-pane fade show active" id="import" role="tabpanel">
                <div class="row">
                    <div class="col-md-8 offset-md-2">
                        <div class="card shadow">
                            <div class="card-header bg-primary text-white">
                                <h5><i class="bi bi-upload"></i> Excel数据导入</h5>
                            </div>
                            <div class="card-body">
                                <div class="alert alert-info">
                                    <i class="bi bi-info-circle"></i> <strong>导入说明：</strong>
                                    <ul class="mb-0 mt-2">
                                        <li>支持.xlsx和.xls格式的Excel文件</li>
                                        <li>首次导入将固化列名，后续导入需保持列名一致</li>
                                        <li>必需字段：样品编号、所属公司、所属水厂、水样类型、采样时间</li>
                                        <li>采样时间格式必须为：YYYY-MM-DD（如2026-01-29）</li>
                                        <li>样品编号重复时可选择跳过、覆盖或终止导入</li>
                                    </ul>
                                </div>

                                <!-- 下载模板按钮 -->
                                <div class="mb-4">
                                    <button type="button" class="btn btn-success btn-lg w-100" id="downloadTemplateBtn">
                                        <i class="bi bi-download"></i> 下载导入模板
                                    </button>
                                    <small class="text-muted d-block mt-2 text-center">
                                        <i class="bi bi-lightbulb"></i> 模板将根据当前系统的列名配置生成，包含详细的填写说明
                                    </small>
                                </div>

                                <!-- 当前列名配置 -->
                                <div class="mb-4" id="currentSchemaDiv" style="display: none;">
                                    <h6>当前系统列名配置：</h6>
                                    <div class="border rounded p-3 bg-light">
                                        <div id="currentSchemaList" class="d-flex flex-wrap gap-2"></div>
                                    </div>
                                </div>

                                <!-- 上传表单 -->
                                <form id="uploadForm">
                                    <div class="mb-3">
                                        <label for="excelFile" class="form-label">选择Excel文件</label>
                                        <input type="file" class="form-control" id="excelFile" accept=".xlsx,.xls" required>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">样品编号重复时的处理方式：</label>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="duplicateOption" id="skipOption" value="skip" checked>
                                            <label class="form-check-label" for="skipOption">
                                                跳过重复记录（推荐）
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="duplicateOption" id="overwriteOption" value="overwrite">
                                            <label class="form-check-label" for="overwriteOption">
                                                覆盖已有记录
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="duplicateOption" id="abortOption" value="abort">
                                            <label class="form-check-label" for="abortOption">
                                                终止导入
                                            </label>
                                        </div>
                                    </div>

                                    <button type="submit" class="btn btn-primary btn-lg w-100">
                                        <i class="bi bi-cloud-upload"></i> 开始导入
                                    </button>
                                </form>

                                <!-- 导入结果 -->
                                <div id="importResult" class="mt-4" style="display: none;">
                                    <h6>导入结果：</h6>
                                    <div id="importResultContent"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 样品查询 -->
            <div class="tab-pane fade" id="search" role="tabpanel">
                <div class="row">
                    <div class="col-md-8 offset-md-2">
                        <div class="card shadow">
                            <div class="card-header bg-success text-white">
                                <h5><i class="bi bi-search"></i> 样品编号精确查询</h5>
                            </div>
                            <div class="card-body">
                                <div class="input-group mb-3">
                                    <input type="text" class="form-control" id="searchSampleNumber" placeholder="输入样品编号">
                                    <button class="btn btn-success" type="button" id="searchBtn">
                                        <i class="bi bi-search"></i> 查询
                                    </button>
                                </div>

                                <!-- 查询结果 -->
                                <div id="searchResult" style="display: none;">
                                    <hr>
                                    <h6>查询结果：</h6>
                                    <div id="searchResultContent"></div>

                                    <div class="mt-3">
                                        <button class="btn btn-primary" id="exportSingleBtn">
                                            <i class="bi bi-download"></i> 导出为Excel
                                        </button>
                                        <button class="btn btn-secondary" id="exportSingleCsvBtn">
                                            <i class="bi bi-filetype-csv"></i> 导出为CSV
                                        </button>
                                    </div>
                                </div>

                                <!-- 未找到提示 -->
                                <div id="searchNotFound" class="alert alert-warning" style="display: none;">
                                    <i class="bi bi-exclamation-triangle"></i> 未找到该样品编号的数据
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 导出模板管理 -->
            <div class="tab-pane fade" id="template" role="tabpanel">
                <div class="row">
                    <div class="col-md-10 offset-md-1">
                        <div class="card shadow">
                            <div class="card-header bg-warning text-dark">
                                <h5><i class="bi bi-file-earmark-text"></i> 导出模板管理</h5>
                            </div>
                            <div class="card-body">
                                <!-- 分类管理 -->
                                <div class="mb-4">
                                    <h6>模板分类管理</h6>
                                    <div class="input-group mb-2">
                                        <input type="text" class="form-control" id="newCategoryName" placeholder="新分类名称（如：出厂水-常规指标）">
                                        <button class="btn btn-primary" id="addCategoryBtn">
                                            <i class="bi bi-plus-circle"></i> 添加分类
                                        </button>
                                    </div>
                                    <div id="categoryList" class="border rounded p-2 bg-light"></div>
                                </div>

                                <hr>

                                <!-- 模板创建 -->
                                <div class="mb-4">
                                    <h6>创建导出模板</h6>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">选择分类</label>
                                                <select class="form-select" id="templateCategory">
                                                    <option value="">请选择分类</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">模板名称</label>
                                                <input type="text" class="form-control" id="templateName" placeholder="如：常规9项">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">选择检测指标（样品编号和采样时间自动包含）</label>
                                        <div id="indicatorCheckboxes" class="border rounded p-3 bg-light" style="max-height: 300px; overflow-y: auto;">
                                            <p class="text-muted">请先导入数据以初始化列名</p>
                                        </div>
                                    </div>
                                    <button class="btn btn-success" id="createTemplateBtn">
                                        <i class="bi bi-plus-circle"></i> 创建模板
                                    </button>
                                </div>

                                <hr>

                                <!-- 已有模板列表 -->
                                <div>
                                    <h6>已有模板</h6>
                                    <div id="templateList"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 筛选导出 -->
            <div class="tab-pane fade" id="export" role="tabpanel">
                <div class="row">
                    <div class="col-md-10 offset-md-1">
                        <div class="card shadow">
                            <div class="card-header bg-info text-white">
                                <h5><i class="bi bi-download"></i> 筛选并导出数据</h5>
                            </div>
                            <div class="card-body">
                                <!-- 选择模板 -->
                                <div class="mb-3">
                                    <label class="form-label"><strong>1. 选择导出模板</strong></label>
                                    <select class="form-select" id="exportTemplate">
                                        <option value="">请选择导出模板</option>
                                    </select>
                                </div>

                                <hr>

                                <!-- 筛选条件 -->
                                <div class="mb-3">
                                    <label class="form-label"><strong>2. 设置筛选条件（单一维度）</strong></label>
                                    <div class="row">
                                        <div class="col-md-4">
                                            <select class="form-select" id="filterField">
                                                <option value="">不筛选（导出全部）</option>
                                                <option value="company_name">所属公司</option>
                                                <option value="plant_name">所属水厂</option>
                                                <option value="sample_type">水样类型</option>
                                                <option value="date_range">采样时间范围</option>
                                            </select>
                                        </div>
                                        <div class="col-md-8">
                                            <div id="filterValueDiv" style="display: none;">
                                                <input type="text" class="form-control" id="filterValue" placeholder="输入筛选值（支持模糊匹配）">
                                            </div>
                                            <div id="dateRangeDiv" style="display: none;">
                                                <div class="row">
                                                    <div class="col-md-6">
                                                        <input type="date" class="form-control" id="dateStart">
                                                    </div>
                                                    <div class="col-md-6">
                                                        <input type="date" class="form-control" id="dateEnd">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <button class="btn btn-secondary mt-2" id="previewBtn">
                                        <i class="bi bi-eye"></i> 预览筛选结果
                                    </button>
                                </div>

                                <!-- 筛选预览 -->
                                <div id="filterPreview" class="mb-3" style="display: none;">
                                    <h6>筛选结果预览（共 <span id="previewCount">0</span> 条）：</h6>
                                    <div class="border rounded p-2 bg-light" style="max-height: 300px; overflow-y: auto;">
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="selectAllSamples">
                                            <label class="form-check-label" for="selectAllSamples">
                                                <strong>全选</strong>
                                            </label>
                                        </div>
                                        <hr>
                                        <div id="sampleCheckboxes"></div>
                                    </div>
                                </div>

                                <hr>

                                <!-- 排序 -->
                                <div class="mb-3">
                                    <label class="form-label"><strong>3. 选择排序方式</strong></label>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="sortOrder" id="sortAsc" value="asc" checked>
                                        <label class="form-check-label" for="sortAsc">
                                            采样时间升序（从早到晚）
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="sortOrder" id="sortDesc" value="desc">
                                        <label class="form-check-label" for="sortDesc">
                                            采样时间降序（从晚到早）
                                        </label>
                                    </div>
                                </div>

                                <hr>

                                <!-- 导出 -->
                                <button class="btn btn-success btn-lg w-100" id="exportBtn">
                                    <i class="bi bi-download"></i> 导出Excel
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentUser = null;
        let currentColumns = null;
        let categories = [];
        let templates = [];
        let currentSampleNumber = '';

        // 页面加载时检查登录状态
        document.addEventListener('DOMContentLoaded', function() {
            checkLogin();
            loadCurrentSchema();
            loadCategories();
            loadTemplates();
        });

        // 检查登录状态
        function checkLogin() {
            fetch('/api/auth/current-user')
                .then(response => response.json())
                .then(data => {
                    if (data.user) {
                        currentUser = data.user;
                        document.getElementById('currentUsername').textContent = data.user.username;
                    } else {
                        window.location.href = '/login';
                    }
                })
                .catch(() => {
                    window.location.href = '/login';
                });
        }

        // 加载当前列名配置
        function loadCurrentSchema() {
            fetch('/api/raw-data/columns')
                .then(response => response.json())
                .then(data => {
                    if (data.columns) {
                        currentColumns = data.columns;
                        document.getElementById('currentSchemaDiv').style.display = 'block';
                        const list = document.getElementById('currentSchemaList');
                        list.innerHTML = data.columns.map(col =>
                            `<span class="badge bg-secondary">${col}</span>`
                        ).join('');

                        // 更新模板管理中的指标选择
                        updateIndicatorCheckboxes(data.columns);
                    }
                });
        }

        // 更新指标选择框
        function updateIndicatorCheckboxes(columns) {
            const baseFields = ['样品编号', '所属公司', '所属水厂', '水样类型', '采样时间'];
            const indicators = columns.filter(col => !baseFields.includes(col));

            const container = document.getElementById('indicatorCheckboxes');
            if (indicators.length === 0) {
                container.innerHTML = '<p class="text-muted">无可选指标</p>';
                return;
            }

            container.innerHTML = indicators.map(ind => `
                <div class="form-check">
                    <input class="form-check-input indicator-checkbox" type="checkbox" value="${ind}" id="ind_${ind}">
                    <label class="form-check-label" for="ind_${ind}">${ind}</label>
                </div>
            `).join('');
        }

        // 下载导入模板
        document.getElementById('downloadTemplateBtn').addEventListener('click', function() {
            const btn = this;
            const originalText = btn.innerHTML;

            // 禁用按钮并显示加载状态
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> 正在生成模板...';

            fetch('/api/raw-data/download-template')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('下载失败');
                    }
                    return response.blob();
                })
                .then(blob => {
                    // 创建下载链接
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;

                    // 生成文件名
                    const timestamp = new Date().toISOString().replace(/[-:]/g, '').split('.')[0].replace('T', '_');
                    a.download = `原始数据导入模板_${timestamp}.xlsx`;

                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);

                    // 恢复按钮状态
                    btn.disabled = false;
                    btn.innerHTML = originalText;

                    // 显示成功提示
                    alert('模板下载成功！请查看下载文件夹。');
                })
                .catch(error => {
                    // 恢复按钮状态
                    btn.disabled = false;
                    btn.innerHTML = originalText;

                    alert('模板下载失败: ' + error.message);
                });
        });

        // 上传表单提交
        document.getElementById('uploadForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const fileInput = document.getElementById('excelFile');
            const file = fileInput.files[0];
            if (!file) {
                alert('请选择文件');
                return;
            }

            const duplicateOption = document.querySelector('input[name="duplicateOption"]:checked').value;

            const formData = new FormData();
            formData.append('file', file);
            formData.append('on_duplicate', duplicateOption);

            const resultDiv = document.getElementById('importResult');
            const resultContent = document.getElementById('importResultContent');

            resultDiv.style.display = 'block';
            resultContent.innerHTML = '<div class="spinner-border" role="status"></div> 正在导入...';

            fetch('/api/raw-data/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    let html = `<div class="alert alert-success">
                        <i class="bi bi-check-circle"></i> ${data.message}
                        <ul class="mb-0 mt-2">
                            <li>总行数: ${data.total_rows}</li>
                            <li>成功导入: ${data.success_count}</li>
                            <li>跳过: ${data.skip_count}</li>
                        </ul>
                    </div>`;

                    if (data.errors && data.errors.length > 0) {
                        html += `<div class="alert alert-danger"><strong>错误信息：</strong><ul class="mb-0">`;
                        data.errors.forEach(err => {
                            html += `<li>${err}</li>`;
                        });
                        html += '</ul></div>';
                    }

                    if (data.warnings && data.warnings.length > 0) {
                        html += `<div class="alert alert-warning"><strong>警告信息：</strong><ul class="mb-0">`;
                        data.warnings.forEach(warn => {
                            html += `<li>${warn}</li>`;
                        });
                        html += '</ul></div>';
                    }

                    resultContent.innerHTML = html;
                    fileInput.value = '';
                    loadCurrentSchema();
                } else {
                    resultContent.innerHTML = `<div class="alert alert-danger">
                        <i class="bi bi-x-circle"></i> ${data.message || data.error}
                    </div>`;
                }
            })
            .catch(error => {
                resultContent.innerHTML = `<div class="alert alert-danger">
                    <i class="bi bi-x-circle"></i> 上传失败: ${error.message}
                </div>`;
            });
        });

        // 样品查询
        document.getElementById('searchBtn').addEventListener('click', function() {
            const sampleNumber = document.getElementById('searchSampleNumber').value.trim();
            if (!sampleNumber) {
                alert('请输入样品编号');
                return;
            }

            currentSampleNumber = sampleNumber;

            fetch('/api/raw-data/search', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({sample_number: sampleNumber})
            })
            .then(response => response.json())
            .then(data => {
                const resultDiv = document.getElementById('searchResult');
                const notFoundDiv = document.getElementById('searchNotFound');
                const contentDiv = document.getElementById('searchResultContent');

                if (data.found) {
                    notFoundDiv.style.display = 'none';
                    resultDiv.style.display = 'block';

                    let html = `<table class="table table-bordered table-sm">
                        <tr><th>样品编号</th><td>${data.data.sample_number}</td></tr>
                        <tr><th>所属公司</th><td>${data.data.company_name || '-'}</td></tr>
                        <tr><th>所属水厂</th><td>${data.data.plant_name || '-'}</td></tr>
                        <tr><th>水样类型</th><td>${data.data.sample_type || '-'}</td></tr>
                        <tr><th>采样时间</th><td>${data.data.sampling_date}</td></tr>
                    </table>
                    <h6 class="mt-3">检测指标：</h6>
                    <table class="table table-bordered table-sm table-striped">`;

                    for (const [key, value] of Object.entries(data.indicators)) {
                        html += `<tr><th>${key}</th><td>${value || '-'}</td></tr>`;
                    }

                    html += '</table>';
                    contentDiv.innerHTML = html;
                } else {
                    resultDiv.style.display = 'none';
                    notFoundDiv.style.display = 'block';
                }
            })
            .catch(error => {
                alert('查询失败: ' + error.message);
            });
        });

        // 导出单条记录
        document.getElementById('exportSingleBtn').addEventListener('click', function() {
            exportSingle('excel');
        });

        document.getElementById('exportSingleCsvBtn').addEventListener('click', function() {
            exportSingle('csv');
        });

        function exportSingle(format) {
            fetch('/api/raw-data/export-single', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    sample_number: currentSampleNumber,
                    format: format
                })
            })
            .then(response => {
                if (response.ok) {
                    return response.blob();
                }
                throw new Error('导出失败');
            })
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${currentSampleNumber}_${new Date().getTime()}.${format === 'csv' ? 'csv' : 'xlsx'}`;
                a.click();
            })
            .catch(error => {
                alert('导出失败: ' + error.message);
            });
        }

        // 加载分类
        function loadCategories() {
            fetch('/api/export-templates/categories')
                .then(response => response.json())
                .then(data => {
                    categories = data.categories || [];
                    updateCategoryList();
                    updateCategorySelect();
                });
        }

        // 更新分类列表
        function updateCategoryList() {
            const list = document.getElementById('categoryList');
            if (categories.length === 0) {
                list.innerHTML = '<p class="text-muted">暂无分类</p>';
                return;
            }

            list.innerHTML = categories.map(cat => `
                <div class="d-flex justify-content-between align-items-center p-2 border-bottom">
                    <span>${cat.name}</span>
                    <button class="btn btn-sm btn-danger" onclick="deleteCategory(${cat.id})">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            `).join('');
        }

        // 更新分类下拉框
        function updateCategorySelect() {
            const select = document.getElementById('templateCategory');
            select.innerHTML = '<option value="">请选择分类</option>' +
                categories.map(cat => `<option value="${cat.id}">${cat.name}</option>`).join('');
        }

        // 添加分类
        document.getElementById('addCategoryBtn').addEventListener('click', function() {
            const name = document.getElementById('newCategoryName').value.trim();
            if (!name) {
                alert('请输入分类名称');
                return;
            }

            fetch('/api/export-templates/categories', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({name: name})
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    document.getElementById('newCategoryName').value = '';
                    loadCategories();
                } else {
                    alert(data.error);
                }
            });
        });

        // 删除分类
        function deleteCategory(id) {
            if (!confirm('确定删除该分类？')) return;

            fetch('/api/export-templates/categories', {
                method: 'DELETE',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({category_id: id})
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    loadCategories();
                } else {
                    alert(data.error);
                }
            });
        }

        // 创建模板
        document.getElementById('createTemplateBtn').addEventListener('click', function() {
            const categoryId = document.getElementById('templateCategory').value;
            const name = document.getElementById('templateName').value.trim();

            if (!name) {
                alert('请输入模板名称');
                return;
            }

            const checkboxes = document.querySelectorAll('.indicator-checkbox:checked');
            const columns = Array.from(checkboxes).map(cb => cb.value);

            if (columns.length === 0) {
                alert('请至少选择一个检测指标');
                return;
            }

            fetch('/api/export-templates', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    category_id: categoryId || null,
                    name: name,
                    columns: columns
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    alert(data.message);
                    document.getElementById('templateName').value = '';
                    document.querySelectorAll('.indicator-checkbox').forEach(cb => cb.checked = false);
                    loadTemplates();
                } else {
                    alert(data.error);
                }
            });
        });

        // 加载模板
        function loadTemplates() {
            fetch('/api/export-templates')
                .then(response => response.json())
                .then(data => {
                    templates = data.templates || [];
                    updateTemplateList();
                    updateExportTemplateSelect();
                });
        }

        // 更新模板列表
        function updateTemplateList() {
            const list = document.getElementById('templateList');
            if (templates.length === 0) {
                list.innerHTML = '<p class="text-muted">暂无模板</p>';
                return;
            }

            list.innerHTML = templates.map(tpl => `
                <div class="card mb-2">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6>${tpl.name}
                                    ${tpl.category_name ? `<span class="badge bg-secondary">${tpl.category_name}</span>` : ''}
                                </h6>
                                <small class="text-muted">包含 ${tpl.columns.length} 个指标</small>
                                <div class="mt-2">
                                    ${tpl.columns.map(col => `<span class="badge bg-light text-dark me-1">${col}</span>`).join('')}
                                </div>
                            </div>
                            <button class="btn btn-sm btn-danger" onclick="deleteTemplate(${tpl.id})">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // 更新导出模板下拉框
        function updateExportTemplateSelect() {
            const select = document.getElementById('exportTemplate');
            select.innerHTML = '<option value="">请选择导出模板</option>' +
                templates.map(tpl => `<option value="${tpl.id}">${tpl.name}${tpl.category_name ? ' (' + tpl.category_name + ')' : ''}</option>`).join('');
        }

        // 删除模板
        function deleteTemplate(id) {
            if (!confirm('确定删除该模板？')) return;

            fetch(`/api/export-templates/${id}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    loadTemplates();
                } else {
                    alert(data.error);
                }
            });
        }

        // 筛选字段变化
        document.getElementById('filterField').addEventListener('change', function() {
            const filterValueDiv = document.getElementById('filterValueDiv');
            const dateRangeDiv = document.getElementById('dateRangeDiv');

            if (this.value === 'date_range') {
                filterValueDiv.style.display = 'none';
                dateRangeDiv.style.display = 'block';
            } else if (this.value) {
                filterValueDiv.style.display = 'block';
                dateRangeDiv.style.display = 'none';
            } else {
                filterValueDiv.style.display = 'none';
                dateRangeDiv.style.display = 'none';
            }
        });

        // 预览筛选结果
        document.getElementById('previewBtn').addEventListener('click', function() {
            const filterField = document.getElementById('filterField').value;
            const filterValue = document.getElementById('filterValue').value;
            const dateStart = document.getElementById('dateStart').value;
            const dateEnd = document.getElementById('dateEnd').value;

            fetch('/api/raw-data/filter-preview', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    filter_field: filterField,
                    filter_value: filterValue,
                    date_start: dateStart,
                    date_end: dateEnd
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                    return;
                }

                const previewDiv = document.getElementById('filterPreview');
                const countSpan = document.getElementById('previewCount');
                const checkboxesDiv = document.getElementById('sampleCheckboxes');

                countSpan.textContent = data.total;

                if (data.total === 0) {
                    checkboxesDiv.innerHTML = '<p class="text-muted">无匹配结果</p>';
                } else {
                    checkboxesDiv.innerHTML = data.results.map(item => `
                        <div class="form-check">
                            <input class="form-check-input sample-checkbox" type="checkbox" value="${item.sample_number}" id="sample_${item.sample_number}">
                            <label class="form-check-label" for="sample_${item.sample_number}">
                                ${item.sample_number} - ${item.company_name || ''} - ${item.plant_name || ''} - ${item.sample_type || ''} - ${item.sampling_date}
                            </label>
                        </div>
                    `).join('');
                }

                previewDiv.style.display = 'block';
            });
        });

        // 全选样品
        document.getElementById('selectAllSamples').addEventListener('change', function() {
            document.querySelectorAll('.sample-checkbox').forEach(cb => {
                cb.checked = this.checked;
            });
        });

        // 导出
        document.getElementById('exportBtn').addEventListener('click', function() {
            const templateId = document.getElementById('exportTemplate').value;
            if (!templateId) {
                alert('请选择导出模板');
                return;
            }

            const filterField = document.getElementById('filterField').value;
            const filterValue = document.getElementById('filterValue').value;
            const dateStart = document.getElementById('dateStart').value;
            const dateEnd = document.getElementById('dateEnd').value;
            const sortOrder = document.querySelector('input[name="sortOrder"]:checked').value;

            const selectedSamples = Array.from(document.querySelectorAll('.sample-checkbox:checked')).map(cb => cb.value);

            fetch('/api/raw-data/filter-export', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    template_id: templateId,
                    filter_field: filterField,
                    filter_value: filterValue,
                    date_start: dateStart,
                    date_end: dateEnd,
                    selected_samples: selectedSamples,
                    sort_order: sortOrder
                })
            })
            .then(response => {
                if (response.ok) {
                    return response.blob();
                }
                return response.json().then(data => {
                    throw new Error(data.error);
                });
            })
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `导出数据_${new Date().getTime()}.xlsx`;
                a.click();
            })
            .catch(error => {
                alert('导出失败: ' + error.message);
            });
        });
    </script>
</body>
</html>
