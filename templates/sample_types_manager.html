<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <title>样品类型管理 - 水质检测报告系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .page-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 2rem 0; margin-bottom: 2rem; }
        .search-box { background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 1.5rem; }
        .table-card { background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .sticky-top { position: sticky; top: 0; z-index: 10; background: white; }
        .sort-order-input::-webkit-outer-spin-button,
        .sort-order-input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .sort-order-input { -moz-appearance: textfield; }
    </style>
</head>
<body>
    <!-- 页面标题 -->
    <div class="page-header">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2><i class="bi bi-tags"></i> 样品类型管理</h2>
                    <p class="mb-0">管理水质检测的样品类型和备注信息</p>
                </div>
                <button class="btn btn-light" onclick="window.location.href='/'">
                    <i class="bi bi-arrow-left"></i> 返回主页
                </button>
            </div>
        </div>
    </div>

    <!-- 主内容区 -->
    <div class="container">
        <!-- 搜索和操作栏 -->
        <div class="search-box">
            <div class="row g-3">
                <div class="col-md-6">
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                        <input type="text" class="form-control" id="searchInput" placeholder="搜索样品名称或备注...">
                        <button class="btn btn-primary" id="searchBtn">搜索</button>
                        <button class="btn btn-outline-secondary" id="resetBtn">重置</button>
                    </div>
                </div>
                <div class="col-md-6 text-end">
                    <button class="btn btn-success" id="addBtn">
                        <i class="bi bi-plus-circle"></i> 添加样品类型
                    </button>
                </div>
            </div>
        </div>

        <!-- 数据表格 -->
        <div class="table-card">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th width="5%">序号</th>
                            <th width="20%">名称</th>
                            <th width="12%">代码</th>
                            <th width="20%">说明</th>
                            <th width="15%">备注</th>
                            <th width="28%">操作</th>
                        </tr>
                    </thead>
                    <tbody id="dataTable"></tbody>
                </table>
            </div>

            <!-- 分页控件 -->
            <div class="p-3 border-top">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <span class="text-muted">共 <strong id="totalCount">0</strong> 条记录</span>
                    </div>
                    <div class="col-md-6">
                        <nav>
                            <ul class="pagination justify-content-end mb-0" id="pagination"></ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加/编辑模态框 -->
    <div class="modal fade" id="editModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">添加样品类型</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editForm">
                        <input type="hidden" id="editId">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">样品名称 <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="editName" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">样品代码 <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="editCode" required>
                                    <div class="form-text">建议使用英文缩写，如：CCW（出厂水）</div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">说明</label>
                                    <textarea class="form-control" id="editDescription" rows="2"></textarea>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">备注</label>
                                    <textarea class="form-control" id="editRemark" rows="2"></textarea>
                                </div>
                                <hr>
                                <h6 class="text-muted mb-3">报告默认值（选择样品类型时自动带入报告）</h6>
                                <div class="mb-3">
                                    <label class="form-label">默认样品状态</label>
                                    <input type="text" class="form-control" id="editDefaultSampleStatus" placeholder="如：样品完好，液态">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">默认采样依据</label>
                                    <input type="text" class="form-control" id="editDefaultSamplingBasis" placeholder="如：GB/T 5750.2-2023">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">默认产品标准</label>
                                    <input type="text" class="form-control" id="editDefaultProductStandard" placeholder="如：《生活饮用水卫生标准》 GB5749-2022">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">默认检测项目</label>
                                    <textarea class="form-control" id="editDefaultDetectionItems" rows="2" placeholder="如：色度、浑浊度、pH等共计43项指标"></textarea>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">默认检测结论</label>
                                    <textarea class="form-control" id="editDefaultTestConclusion" rows="2" placeholder="如：该水样所检项目均符合标准限值要求"></textarea>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label d-flex justify-content-between align-items-center">
                                        <span>检测项目</span>
                                        <div>
                                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="toggleAllIndicators(true)">全选</button>
                                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="toggleAllIndicators(false)">取消全选</button>
                                        </div>
                                    </label>
                                    <div id="indicatorsList" style="max-height: 400px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 4px; padding: 10px;">
                                        <div class="text-center text-muted py-3">
                                            <span class="spinner-border spinner-border-sm me-2"></span>
                                            加载中...
                                        </div>
                                    </div>
                                    <div class="form-text mt-2">
                                        <span id="selectedCount">0</span> 个项目已选中
                                        <button type="button" class="btn btn-sm btn-info ms-3" onclick="openSortModal()" id="sortBtn" style="display:none;">
                                            <i class="bi bi-arrows-move"></i> 调整顺序
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="saveBtn">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 排序模态框 -->
    <div class="modal fade" id="sortModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-list-ol"></i> 调整检测项目顺序</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> 在"序号"列输入数字调整顺序（如1,2,3...），点击"应用排序"按钮生效
                    </div>
                    <div class="mb-3 d-flex justify-content-between align-items-center">
                        <div>
                            <button type="button" class="btn btn-sm btn-primary" onclick="applySort()">
                                <i class="bi bi-check-circle"></i> 应用排序
                            </button>
                            <button type="button" class="btn btn-sm btn-secondary" onclick="resetSort()">
                                <i class="bi bi-arrow-counterclockwise"></i> 重置为原始顺序
                            </button>
                        </div>
                        <small class="text-muted">提示：序号相同时保持原有顺序</small>
                    </div>
                    <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                        <table class="table table-sm table-hover">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th width="15%">序号</th>
                                    <th width="35%">检测项目名称</th>
                                    <th width="15%">单位</th>
                                    <th width="35%">分组</th>
                                </tr>
                            </thead>
                            <tbody id="sortableList">
                                <!-- 排序项目列表 -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                    <button type="button" class="btn btn-primary" onclick="applySortAndClose()">
                        <i class="bi bi-check-lg"></i> 应用并关闭
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/csrf_helper.js"></script>
    <script>
        // 全局变量
        let allData = [];
        let filteredData = [];
        let currentPage = 1;
        const itemsPerPage = 10;
        const modal = new bootstrap.Modal(document.getElementById('editModal'));
        let allIndicators = [];  // 所有检测项目
        let indicatorGroups = [];  // 检测项目分组
        let currentVersion = null;  // 当前编辑项的版本号

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            loadIndicators();
            initEventListeners();
        });

        // 加载数据
        async function loadData(search = '') {
            try {
                const url = search ? `/api/sample-types?search=${encodeURIComponent(search)}` : '/api/sample-types';
                const response = await fetch(url);
                if (!response.ok) throw new Error('加载数据失败');

                allData = await response.json();
                filteredData = allData;
                currentPage = 1;
                renderTable();
                renderPagination();
            } catch (error) {
                alert('加载数据失败: ' + error.message);
            }
        }

        // 加载检测项目和分组
        async function loadIndicators() {
            try {
                // 加载分组
                const groupsRes = await fetch('/api/indicator-groups');
                if (groupsRes.ok) {
                    indicatorGroups = await groupsRes.json();
                }

                // 加载所有检测项目
                const indicatorsRes = await fetch('/api/indicators');
                if (indicatorsRes.ok) {
                    allIndicators = await indicatorsRes.json();
                }
            } catch (error) {
                console.error('加载检测项目失败:', error);
            }
        }

        // 渲染检测项目列表（按分组显示）
        function renderIndicatorsList(selectedIds = []) {
            const container = document.getElementById('indicatorsList');
            container.innerHTML = '';

            if (allIndicators.length === 0) {
                container.innerHTML = '<div class="text-center text-muted py-3">暂无检测项目</div>';
                return;
            }

            // 按分组组织检测项目
            const groupedIndicators = {};
            indicatorGroups.forEach(group => {
                groupedIndicators[group.id] = {
                    name: group.name,
                    indicators: []
                };
            });

            // 未分组项目
            groupedIndicators[0] = {
                name: '未分组',
                indicators: []
            };

            allIndicators.forEach(indicator => {
                const groupId = indicator.group_id || 0;
                if (groupedIndicators[groupId]) {
                    groupedIndicators[groupId].indicators.push(indicator);
                }
            });

            // 渲染每个分组
            Object.keys(groupedIndicators).forEach(groupId => {
                const group = groupedIndicators[groupId];
                if (group.indicators.length === 0) return;

                const groupDiv = document.createElement('div');
                groupDiv.className = 'mb-3';
                groupDiv.setAttribute('data-group-id', groupId);
                groupDiv.innerHTML = `
                    <div class="fw-bold text-primary mb-2 d-flex justify-content-between align-items-center">
                        <span><i class="bi bi-folder"></i> ${group.name}</span>
                        <div>
                            <button type="button" class="btn btn-sm btn-outline-primary me-1"
                                    onclick="toggleGroupIndicators('${groupId}', true)"
                                    title="全选${group.name}">
                                <i class="bi bi-check-all"></i> 全选此类
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary"
                                    onclick="toggleGroupIndicators('${groupId}', false)"
                                    title="取消全选${group.name}">
                                <i class="bi bi-x-circle"></i> 取消此类
                            </button>
                        </div>
                    </div>
                    <div class="ps-3">
                        ${group.indicators.map(ind => `
                            <div class="form-check mb-2">
                                <input class="form-check-input indicator-checkbox" type="checkbox"
                                       value="${ind.id}" id="indicator_${ind.id}"
                                       ${selectedIds.includes(ind.id) ? 'checked' : ''}
                                       onchange="updateSelectedCount()">
                                <label class="form-check-label" for="indicator_${ind.id}">
                                    <strong>${ind.name}</strong>
                                    ${ind.unit ? `<span class="text-muted small"> (${ind.unit})</span>` : ''}
                                    ${ind.remark ? `<br><small class="text-muted"><i class="bi bi-info-circle"></i> ${ind.remark}</small>` : ''}
                                </label>
                            </div>
                        `).join('')}
                    </div>
                `;
                container.appendChild(groupDiv);
            });

            updateSelectedCount();
        }

        // 更新选中数量
        function updateSelectedCount() {
            const checkboxes = document.querySelectorAll('.indicator-checkbox');
            const checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
            document.getElementById('selectedCount').textContent = checkedCount;

            // 显示或隐藏排序按钮
            const sortBtn = document.getElementById('sortBtn');
            if (checkedCount > 0) {
                sortBtn.style.display = 'inline-block';
            } else {
                sortBtn.style.display = 'none';
            }
        }

        // 全选/取消全选
        function toggleAllIndicators(select) {
            const checkboxes = document.querySelectorAll('.indicator-checkbox');
            checkboxes.forEach(cb => cb.checked = select);
            updateSelectedCount();
        }

        // 按分组全选/取消全选
        function toggleGroupIndicators(groupId, select) {
            const groupDiv = document.querySelector(`[data-group-id="${groupId}"]`);
            if (groupDiv) {
                const checkboxes = groupDiv.querySelectorAll('.indicator-checkbox');
                checkboxes.forEach(cb => cb.checked = select);
                updateSelectedCount();
            }
        }

        // 获取选中的检测项目ID列表（按当前排序后的顺序）
        let sortedIndicatorIds = [];  // 存储排序后的ID列表

        function getSelectedIndicatorIds() {
            const checkboxes = document.querySelectorAll('.indicator-checkbox:checked');
            const selectedIds = Array.from(checkboxes).map(cb => parseInt(cb.value));

            // 如果有排序记录，按排序顺序返回
            if (sortedIndicatorIds.length > 0) {
                const orderedIds = [];
                sortedIndicatorIds.forEach(id => {
                    if (selectedIds.includes(id)) {
                        orderedIds.push(id);
                    }
                });
                // 添加排序列表中没有的新选中项
                selectedIds.forEach(id => {
                    if (!orderedIds.includes(id)) {
                        orderedIds.push(id);
                    }
                });
                return orderedIds;
            }

            return selectedIds;
        }

        // 渲染表格
        function renderTable() {
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageData = filteredData.slice(startIndex, endIndex);

            const tbody = document.getElementById('dataTable');
            tbody.innerHTML = '';

            if (pageData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted py-4">暂无数据</td></tr>';
                return;
            }

            pageData.forEach((item, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${startIndex + index + 1}</td>
                    <td>${item.name || '-'}</td>
                    <td><span class="badge bg-primary">${item.code || '-'}</span></td>
                    <td><small class="text-muted">${item.description || '-'}</small></td>
                    <td><small class="text-muted">${item.remark || '-'}</small></td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="editItem(${item.id})" title="编辑">
                            <i class="bi bi-pencil"></i> 编辑
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteItem(${item.id}, '${item.name}')" title="删除">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });

            document.getElementById('totalCount').textContent = filteredData.length;
        }

        // 渲染分页
        function renderPagination() {
            const totalPages = Math.ceil(filteredData.length / itemsPerPage);
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';

            if (totalPages <= 1) return;

            // 上一页
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
            prevLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage - 1}); return false;">上一页</a>`;
            pagination.appendChild(prevLi);

            // 页码
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                    const li = document.createElement('li');
                    li.className = `page-item ${i === currentPage ? 'active' : ''}`;
                    li.innerHTML = `<a class="page-link" href="#" onclick="changePage(${i}); return false;">${i}</a>`;
                    pagination.appendChild(li);
                } else if (i === currentPage - 3 || i === currentPage + 3) {
                    const li = document.createElement('li');
                    li.className = 'page-item disabled';
                    li.innerHTML = '<span class="page-link">...</span>';
                    pagination.appendChild(li);
                }
            }

            // 下一页
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
            nextLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage + 1}); return false;">下一页</a>`;
            pagination.appendChild(nextLi);
        }

        // 切换页码
        function changePage(page) {
            const totalPages = Math.ceil(filteredData.length / itemsPerPage);
            if (page < 1 || page > totalPages) return;
            currentPage = page;
            renderTable();
            renderPagination();
        }

        // 初始化事件监听
        function initEventListeners() {
            // 搜索
            document.getElementById('searchBtn').addEventListener('click', () => {
                const search = document.getElementById('searchInput').value.trim();
                loadData(search);
            });

            // 回车搜索
            document.getElementById('searchInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    document.getElementById('searchBtn').click();
                }
            });

            // 重置
            document.getElementById('resetBtn').addEventListener('click', () => {
                document.getElementById('searchInput').value = '';
                loadData();
            });

            // 添加
            document.getElementById('addBtn').addEventListener('click', () => {
                document.getElementById('modalTitle').textContent = '添加样品类型';
                document.getElementById('editForm').reset();
                document.getElementById('editId').value = '';
                currentVersion = null;  // 清空版本号
                sortedIndicatorIds = [];  // 清空排序记录
                renderIndicatorsList([]);  // 清空选择
                modal.show();
            });

            // 保存
            document.getElementById('saveBtn').addEventListener('click', saveItem);
        }

        // 编辑项目
        async function editItem(id) {
            try {
                // 获取样品类型详情（包括关联的检测项目）
                const response = await fetch(`/api/sample-types/${id}`);
                if (!response.ok) throw new Error('加载数据失败');

                const item = await response.json();

                document.getElementById('modalTitle').textContent = '编辑样品类型';
                document.getElementById('editId').value = item.id;
                document.getElementById('editName').value = item.name || '';
                document.getElementById('editCode').value = item.code || '';
                document.getElementById('editDescription').value = item.description || '';
                document.getElementById('editRemark').value = item.remark || '';
                document.getElementById('editDefaultSampleStatus').value = item.default_sample_status || '';
                document.getElementById('editDefaultSamplingBasis').value = item.default_sampling_basis || '';
                document.getElementById('editDefaultProductStandard').value = item.default_product_standard || '';
                document.getElementById('editDefaultDetectionItems').value = item.default_detection_items || '';
                document.getElementById('editDefaultTestConclusion').value = item.default_test_conclusion || '';

                // 保存当前的版本号和排序顺序
                currentVersion = item.version || 1;
                sortedIndicatorIds = item.indicator_ids || [];

                // 渲染检测项目列表并选中已关联的项目
                renderIndicatorsList(item.indicator_ids || []);

                modal.show();
            } catch (error) {
                alert('加载数据失败: ' + error.message);
            }
        }

        // 保存项目
        async function saveItem() {
            const id = document.getElementById('editId').value;
            const name = document.getElementById('editName').value.trim();
            const code = document.getElementById('editCode').value.trim();
            const description = document.getElementById('editDescription').value.trim();
            const remark = document.getElementById('editRemark').value.trim();
            const indicator_ids = getSelectedIndicatorIds();
            const default_sample_status = document.getElementById('editDefaultSampleStatus').value.trim();
            const default_sampling_basis = document.getElementById('editDefaultSamplingBasis').value.trim();
            const default_product_standard = document.getElementById('editDefaultProductStandard').value.trim();
            const default_detection_items = document.getElementById('editDefaultDetectionItems').value.trim();
            const default_test_conclusion = document.getElementById('editDefaultTestConclusion').value.trim();

            if (!name || !code) {
                alert('样品名称和代码不能为空');
                return;
            }

            const data = {
                name,
                code,
                description,
                remark,
                indicator_ids,  // 包含选中的检测项目ID列表
                default_sample_status,
                default_sampling_basis,
                default_product_standard,
                default_detection_items,
                default_test_conclusion
            };

            // 如果是更新操作，附加版本号
            if (id && currentVersion !== null) {
                data.version = currentVersion;
            }

            try {
                let response;
                if (id) {
                    response = await fetch(`/api/sample-types/${id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                } else {
                    response = await fetch('/api/sample-types', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                }

                if (!response.ok) {
                    const error = await response.json();

                    // 处理版本冲突
                    if (response.status === 409 && error.conflict) {
                        const retry = confirm(
                            '数据已被其他用户修改！\n\n' +
                            '可能的原因：\n' +
                            '1. 其他管理员同时编辑了此样品类型\n' +
                            '2. 您在多个浏览器标签页中打开了编辑界面\n\n' +
                            '点击"确定"关闭此窗口并刷新列表，查看最新数据\n' +
                            '点击"取消"留在此页面（您的修改将不会保存）'
                        );

                        if (retry) {
                            modal.hide();
                            loadData();
                        }
                        return;
                    }

                    throw new Error(error.error || '保存失败');
                }

                const result = await response.json();

                // 更新版本号
                if (result.version) {
                    currentVersion = result.version;
                }

                modal.hide();
                loadData();
                alert(id ? '更新成功' : '添加成功');
            } catch (error) {
                alert('保存失败: ' + error.message);
            }
        }

        // 删除项目
        async function deleteItem(id, name) {
            if (!confirm(`确定要删除样品类型"${name}"吗？`)) return;

            try {
                const response = await fetch(`/api/sample-types/${id}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || '删除失败');
                }

                loadData();
                alert('删除成功');
            } catch (error) {
                alert('删除失败: ' + error.message);
            }
        }

        // 排序功能
        let sortModal = null;
        let originalSortOrder = []; // 保存原始顺序用于重置

        function openSortModal() {
            // 获取当前选中的检测项目
            const checkboxes = document.querySelectorAll('.indicator-checkbox:checked');
            const selectedIds = Array.from(checkboxes).map(cb => parseInt(cb.value));

            if (selectedIds.length === 0) {
                alert('请先选择检测项目');
                return;
            }

            // 获取选中项目的详细信息（按当前排序或默认顺序）
            let selectedIndicators = [];
            if (sortedIndicatorIds.length > 0) {
                // 按已保存的排序顺序
                sortedIndicatorIds.forEach(id => {
                    if (selectedIds.includes(id)) {
                        const ind = allIndicators.find(i => i.id === id);
                        if (ind) selectedIndicators.push(ind);
                    }
                });
                // 添加新选中的项目
                selectedIds.forEach(id => {
                    if (!sortedIndicatorIds.includes(id)) {
                        const ind = allIndicators.find(i => i.id === id);
                        if (ind) selectedIndicators.push(ind);
                    }
                });
            } else {
                // 默认顺序
                selectedIndicators = allIndicators.filter(ind => selectedIds.includes(ind.id));
            }

            // 保存原始顺序
            originalSortOrder = selectedIndicators.map(ind => ind.id);

            // 渲染排序列表
            renderSortList(selectedIndicators);

            // 显示模态框
            if (!sortModal) {
                sortModal = new bootstrap.Modal(document.getElementById('sortModal'));
            }
            sortModal.show();
        }

        // 渲染排序列表
        function renderSortList(selectedIndicators) {
            const sortableList = document.getElementById('sortableList');
            sortableList.innerHTML = '';

            selectedIndicators.forEach((ind, index) => {
                const groupName = indicatorGroups.find(g => g.id === ind.group_id)?.name || '未分组';
                const row = document.createElement('tr');
                row.setAttribute('data-id', ind.id);
                row.innerHTML = `
                    <td>
                        <input type="number"
                               class="form-control form-control-sm sort-order-input"
                               value="${index + 1}"
                               min="1"
                               max="${selectedIndicators.length}"
                               data-id="${ind.id}"
                               style="width: 80px;">
                    </td>
                    <td>
                        <strong>${ind.name}</strong>
                        ${ind.remark ? `<br><small class="text-muted">${ind.remark}</small>` : ''}
                    </td>
                    <td>${ind.unit || '-'}</td>
                    <td><span class="badge bg-secondary">${groupName}</span></td>
                `;
                sortableList.appendChild(row);
            });
        }

        // 应用排序
        function applySort() {
            const inputs = document.querySelectorAll('.sort-order-input');

            // 收集所有项目及其序号
            const items = Array.from(inputs).map(input => ({
                id: parseInt(input.getAttribute('data-id')),
                order: parseInt(input.value) || 999
            }));

            // 按序号排序
            items.sort((a, b) => a.order - b.order);

            // 更新排序后的ID列表
            sortedIndicatorIds = items.map(item => item.id);

            // 重新渲染列表以反映新顺序
            const selectedIndicators = sortedIndicatorIds.map(id =>
                allIndicators.find(ind => ind.id === id)
            ).filter(ind => ind);

            renderSortList(selectedIndicators);

            // 显示提示
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-success alert-dismissible fade show mt-2';
            alertDiv.innerHTML = `
                <i class="bi bi-check-circle"></i> 排序已应用！列表已按新序号重新排列
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.querySelector('#sortModal .modal-body').insertBefore(
                alertDiv,
                document.querySelector('#sortModal .table-responsive')
            );

            // 3秒后自动关闭提示
            setTimeout(() => {
                alertDiv.remove();
            }, 3000);
        }

        // 重置为原始顺序
        function resetSort() {
            if (originalSortOrder.length === 0) {
                alert('没有可重置的顺序');
                return;
            }

            sortedIndicatorIds = [...originalSortOrder];

            const selectedIndicators = sortedIndicatorIds.map(id =>
                allIndicators.find(ind => ind.id === id)
            ).filter(ind => ind);

            renderSortList(selectedIndicators);

            alert('已重置为原始顺序');
        }

        // 应用并关闭
        function applySortAndClose() {
            applySort();

            // 延迟关闭，让用户看到成功提示
            setTimeout(() => {
                if (sortModal) {
                    sortModal.hide();
                }
            }, 500);
        }

    </script>
</body>
</html>
