# 模板配置编辑器使用说明

## 概述

模板配置编辑器是一个专门用于管理Excel报告模板字段配置的独立页面。通过这个编辑器，您可以方便地添加、编辑、删除字段配置，并支持批量导入导出。

## 主要功能

### 1. 字段管理
- ✅ **添加字段**：创建新的字段配置
- ✅ **编辑字段**：修改现有字段的属性
- ✅ **删除字段**：单个删除或批量删除字段
- ✅ **搜索过滤**：按字段名称搜索，按类型筛选

### 2. 导入导出
- ✅ **导出配置**：将模板配置导出为Excel文件
- ✅ **导入配置**：从Excel文件导入字段配置
- ✅ **批量操作**：支持一次性导入多个字段

### 3. 界面特性
- ✅ **实时统计**：显示字段总数
- ✅ **类型标记**：不同字段类型用不同颜色标识
- ✅ **批量选择**：支持全选和批量删除
- ✅ **响应式设计**：适配各种屏幕尺寸

## 使用方法

### 访问编辑器

1. **从模板管理页面进入**
   - 访问 `/report-template-manager` 或 `/report-templates`
   - 找到需要配置的模板
   - 点击 **"配置字段"** 按钮（蓝色主按钮）

2. **直接访问**
   - URL：`/template-config-editor?id=模板ID`

### 添加字段

1. 点击工具栏的 **"添加字段"** 按钮
2. 在弹出的对话框中填写字段信息：
   - **字段名称**（必填）：唯一标识符，如 `report_number`
   - **显示名称**（可选）：界面显示名称，如 `报告编号`
   - **字段类型**（必填）：选择字段类型
     - `text`：文本字段
     - `date`：日期字段
     - `selection`：选择字段
     - `table_data`：表格数据
     - `signature`：签名字段
     - `constant`：常量字段
     - `formula`：公式字段
   - **工作表名称**（必填）：字段所在的Excel工作表
   - **单元格地址**（可选）：如 `A1`, `B2`
   - **是否必填**：选择"是"或"否"
   - **占位符**（可选）：输入框提示文本
   - **默认值**（可选）：字段的默认值
   - **描述**（可选）：字段的详细说明
3. 点击 **"保存"** 按钮

### 编辑字段

1. 在字段列表中找到需要编辑的字段
2. 点击该字段行的 **"编辑"** 按钮
3. 修改字段信息
4. 点击 **"保存"** 按钮

### 删除字段

**单个删除：**
1. 在字段列表中找到需要删除的字段
2. 点击该字段行的 **"删除"** 按钮
3. 确认删除操作

**批量删除：**
1. 勾选要删除的字段（可以使用表头的全选复选框）
2. 点击工具栏的 **"批量删除"** 按钮
3. 确认删除操作

### 搜索和筛选

**搜索：**
- 在搜索框中输入关键字
- 系统会实时过滤匹配的字段（支持字段名称、显示名称、描述）

**筛选：**
- 在类型下拉框中选择字段类型
- 表格会只显示该类型的字段

**组合使用：**
- 可以同时使用搜索和类型筛选

### 导出配置

1. 点击工具栏的 **"导出配置"** 按钮
2. 系统会生成Excel文件并自动下载
3. 文件名格式：`模板名称_配置_日期.xlsx`

**导出的Excel文件包含：**
- **模板配置**工作表：所有字段的详细信息
- **导入说明**工作表：使用说明和注意事项

### 导入配置

⚠️ **重要提示**：导入配置会删除该模板的所有现有字段配置，然后重新创建。请先导出备份！

1. 点击工具栏的 **"导入配置"** 按钮
2. 在弹出的对话框中选择配置文件（必须是之前导出的Excel文件）
3. 点击 **"开始导入"** 按钮
4. 等待导入完成

**注意事项：**
- Excel文件必须包含名为 **"模板配置"** 的工作表
- 必填列：字段名称、字段类型、工作表名称、是否必填
- 字段类型必须是系统支持的类型之一
- "是否必填"列只能填 **"是"** 或 **"否"**

## 字段类型说明

| 类型 | 代码 | 说明 | 颜色标记 |
|------|------|------|----------|
| 文本字段 | text | 普通文本输入 | 蓝色 |
| 日期字段 | date | 日期选择器 | 绿色 |
| 选择字段 | selection | 下拉选择 | 黄色 |
| 表格数据 | table_data | 表格形式的数据 | 青色 |
| 签名字段 | signature | 签名信息 | 灰色 |
| 常量字段 | constant | 固定不变的值 | 黑色 |
| 公式字段 | formula | 计算公式 | 红色 |

## 快捷操作

- **全选字段**：点击表头的复选框
- **刷新列表**：点击工具栏的刷新按钮
- **返回模板列表**：点击页面右上角的 **"返回模板列表"** 按钮

## API接口

### 页面路由
```
GET /template-config-editor?id={模板ID}
```

### 字段操作API
```
GET    /api/template-fields/{字段ID}        # 获取字段详情
PUT    /api/template-fields/{字段ID}        # 更新字段
DELETE /api/template-fields/{字段ID}        # 删除字段
POST   /api/report-templates/{模板ID}/fields  # 添加字段
```

### 配置导入导出API
```
GET  /api/report-templates/{模板ID}/export-config  # 导出配置
POST /api/report-templates/{模板ID}/import-config  # 导入配置
```

## 权限要求

- **查看**：需要登录
- **添加/编辑/删除字段**：需要管理员权限
- **导入/导出配置**：导出需要登录，导入需要管理员权限

## 技术架构

### 前端
- **框架**：Bootstrap 5.3
- **图标**：Bootstrap Icons
- **样式**：自定义CSS + 渐变色设计

### 后端
- **框架**：Flask
- **数据库**：SQLite
- **Excel处理**：openpyxl

### 文件结构
```
water-quality-report/
├── templates/
│   ├── template_config_editor.html    # 配置编辑器页面
│   └── report_template_manager.html   # 模板管理页面
├── template_config_excel.py           # 导入导出模块
├── app_v2.py                          # Flask应用（含API）
├── test_template_config.py            # 测试脚本
└── exports/
    └── template_configs/              # 配置导出目录
```

## 常见问题

### Q: 删除字段后能恢复吗？
A: 不能。删除是永久性的，建议在删除前先导出配置作为备份。

### Q: 导入配置后原来的字段怎么办？
A: 导入会删除所有原有字段，然后重新创建。建议先导出备份。

### Q: 可以同时编辑多个字段吗？
A: 不可以。每次只能编辑一个字段，但可以使用批量删除功能。

### Q: 字段名称可以重复吗？
A: 可以，但不建议。字段名称应该是唯一的标识符。

### Q: 导出的Excel文件可以手动编辑吗？
A: 可以，但必须保持格式和必填列不变，否则导入会失败。

## 版本历史

### v1.0 (2026-01-27)
- ✅ 初始版本发布
- ✅ 支持字段的增删改查
- ✅ 支持配置导入导出
- ✅ 支持搜索和筛选
- ✅ 支持批量操作

## 技术支持

如有问题，请联系系统管理员或查看项目文档。
